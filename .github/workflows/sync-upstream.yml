name: Sync with Upstream & Auto-Build

on:
  # VÃ©rifie automatiquement toutes les 6 heures
  schedule:
    - cron: '0 */6 * * *'

  # Permet le dÃ©clenchement manuel
  workflow_dispatch:

  # DÃ©clenche aussi sur push (pour tester)
  push:
    branches: [ master, main ]

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    environment: ENV_GAMEVAULT

    steps:
    - name: Checkout private repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/Phalcode/gamevault-app.git || true
        git remote -v

    - name: Fetch upstream changes
      run: |
        git fetch upstream
        echo "ðŸ“¥ Fetched upstream changes"

    - name: Check for updates
      id: check_updates
      run: |
        UPSTREAM_SHA=$(git rev-parse upstream/master)
        CURRENT_SHA=$(git rev-parse HEAD)

        echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
        echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT

        if [ "$UPSTREAM_SHA" != "$CURRENT_SHA" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ New updates detected!"
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "âœ… Already up to date"
        fi

    - name: Merge upstream changes
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ðŸ”€ Merging upstream/master into master..."
        git merge upstream/master --no-edit || {
          echo "âš ï¸ Merge conflict detected, attempting auto-resolution..."
          # En cas de conflit, garder notre version du paywall removal
          git checkout --ours gamevault/Models/PhalcodeProduct.cs 2>/dev/null || true
          git add gamevault/Models/PhalcodeProduct.cs 2>/dev/null || true
          git commit -m "Merge upstream with paywall removal preserved" || true
        }

    - name: Re-apply paywall removal
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ðŸ”“ Re-applying paywall removal..."

        # VÃ©rifier si dÃ©jÃ  appliquÃ©
        if grep -q "Modified for personal use" gamevault/Models/PhalcodeProduct.cs; then
          echo "âœ… Paywall removal already applied"
        else
          echo "ðŸ“ Applying paywall removal modification..."

          # Appliquer le patch
          git apply paywall-removal.patch || {
            echo "âš ï¸ Patch failed, applying manual modification..."

            # Modification manuelle en cas d'Ã©chec du patch
            sed -i '/public bool IsActive()/,/^[[:space:]]*}$/ {
              /return (CurrentPeriodEnd != null && CurrentPeriodEnd > DateTime.UtcNow);/c\
            // Modified for personal use - always return true to enable all features\
            // Original check: return (CurrentPeriodEnd != null && CurrentPeriodEnd > DateTime.UtcNow);\
            return true;
            }' gamevault/Models/PhalcodeProduct.cs
          }

          git add gamevault/Models/PhalcodeProduct.cs
          git commit -m "Re-apply paywall removal after upstream merge" || true
        fi

    - name: Push changes
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "â¬†ï¸ Pushing changes to private repo..."
        git push origin master
        echo "âœ… Changes pushed successfully!"

    - name: Trigger build workflow
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ðŸš€ Build will be triggered automatically by push event"

    - name: Summary
      run: |
        echo "## ðŸŽ¯ Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ]; then
          echo "âœ… **Upstream synchronized successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Merged from: \`upstream/master\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream SHA: \`${{ steps.check_updates.outputs.upstream_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Previous SHA: \`${{ steps.check_updates.outputs.current_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Paywall removal: âœ… Re-applied" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ðŸš€ Triggered" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **No updates available**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The fork is already up to date with upstream." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ Next check: In 6 hours" >> $GITHUB_STEP_SUMMARY
