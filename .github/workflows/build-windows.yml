name: Build GameVault (Paywall Removed)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Apply Paywall Removal
      run: |
        Write-Host "Applying paywall removal modification..." -ForegroundColor Cyan
        .\apply-paywall-removal.ps1
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore gamevault/gamevault.csproj

    - name: Build
      run: dotnet build gamevault/gamevault.csproj --configuration Release --no-restore

    - name: Create release package
      run: |
        $version = "custom-build-$(Get-Date -Format 'yyyy-MM-dd-HHmmss')"
        $outputPath = "gamevault/bin/Release/net8.0-windows10.0.22000.0"
        $artifactPath = "GameVault-$version"

        New-Item -ItemType Directory -Force -Path $artifactPath
        Copy-Item -Path "$outputPath/*" -Destination $artifactPath -Recurse

        # Create version info file
        @"
        GameVault Build Information
        ===========================
        Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        Commit: $env:GITHUB_SHA
        Branch: $env:GITHUB_REF_NAME

        Modifications:
        - Paywall removed for personal use
        - All premium features unlocked

        See PAYWALL_REMOVAL.md for details
        "@ | Out-File -FilePath "$artifactPath/BUILD_INFO.txt"

        # Copy documentation
        Copy-Item -Path "PAYWALL_REMOVAL.md" -Destination $artifactPath -ErrorAction SilentlyContinue
        Copy-Item -Path "QUICK_START.md" -Destination $artifactPath -ErrorAction SilentlyContinue
        Copy-Item -Path "README.md" -Destination $artifactPath -ErrorAction SilentlyContinue

        Compress-Archive -Path $artifactPath -DestinationPath "GameVault-NoPaywall-$version.zip"
      shell: pwsh

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: gamevault-windows-no-paywall
        path: GameVault-NoPaywall-*.zip
        retention-days: 90

    - name: Upload build directory
      uses: actions/upload-artifact@v4
      with:
        name: gamevault-windows-build-files
        path: gamevault/bin/Release/net8.0-windows10.0.22000.0/
        retention-days: 30

    - name: Create GitHub Release
      if: github.event_name == 'push'
      run: |
        $version = "v$(Get-Date -Format 'yyyy.MM.dd-HHmmss')"
        $zipFile = Get-ChildItem -Filter "GameVault-NoPaywall-*.zip" | Select-Object -First 1

        # Cr√©er le tag
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git tag -a "$version" -m "Auto-build release $version"
        git push origin "$version"

        # Cr√©er la release
        $releaseNotes = @"
        # GameVault Private Build - $version

        üîì **All premium features unlocked for personal use**

        ## ‚ú® Features
        - ‚úÖ Multiple User Profiles
        - ‚úÖ Cloud Saves (automatic backup/restore)
        - ‚úÖ Steam Shortcuts Sync
        - ‚úÖ Discord Rich Presence
        - ‚úÖ Premium Themes
        - ‚úÖ Animated GIF Avatars
        - ‚úÖ CLI Auto-Install
        - ‚úÖ Install/Uninstall Commands

        ## üì¶ Installation
        1. Download \`GameVault-NoPaywall-*.zip\`
        2. Extract to a folder
        3. Run \`gamevault.exe\`

        ## ‚ÑπÔ∏è Build Info
        - **Build Date:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        - **Commit:** $env:GITHUB_SHA
        - **Branch:** $env:GITHUB_REF_NAME
        - **Upstream:** Synced with [Phalcode/gamevault-app](https://github.com/Phalcode/gamevault-app)

        ## ‚ö†Ô∏è Important
        This is a **private build for personal use only**.
        Paywall has been removed as permitted by the developers for non-commercial use.

        See \`PAYWALL_REMOVAL.md\` in the package for details.

        ---
        ü§ñ Auto-generated by GitHub Actions
        "@

        # Utiliser gh CLI pour cr√©er la release
        echo "$releaseNotes" | Out-File -FilePath release-notes.md -Encoding UTF8
        gh release create "$version" "$($zipFile.Name)" `
          --title "GameVault Private Build $version" `
          --notes-file release-notes.md `
          --repo "$env:GITHUB_REPOSITORY"
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build summary
      run: |
        Write-Host "‚úÖ Build completed successfully!" -ForegroundColor Green
        Write-Host ""
        Write-Host "Download the artifacts from the Actions tab:" -ForegroundColor Cyan
        Write-Host "  - gamevault-windows-no-paywall.zip (ready to run)" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "All premium features unlocked:" -ForegroundColor Green
        Write-Host "  ‚úÖ Multiple User Profiles" -ForegroundColor Green
        Write-Host "  ‚úÖ Cloud Saves" -ForegroundColor Green
        Write-Host "  ‚úÖ Steam Shortcuts Sync" -ForegroundColor Green
        Write-Host "  ‚úÖ Discord Rich Presence" -ForegroundColor Green
        Write-Host "  ‚úÖ Premium Themes" -ForegroundColor Green
        Write-Host "  ‚úÖ Animated GIF Avatars" -ForegroundColor Green
        Write-Host "  ‚úÖ CLI Auto-Install" -ForegroundColor Green
        Write-Host "  ‚úÖ Install/Uninstall Commands" -ForegroundColor Green
        Write-Host ""
        Write-Host "‚ö†Ô∏è  Remember: For PERSONAL USE only" -ForegroundColor Yellow
        Write-Host "    Support the devs: https://gamevau.lt/gamevault-plus" -ForegroundColor Yellow
      shell: pwsh
